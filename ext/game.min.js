/* EntityJS v0.4.2 entityjs.com | License entityjs.com/license */
function randBetween(e,t){return e+Math.ceil((t-e+1)*Math.random())-1}re=function(e){return new re.query(e)},re.version="0.4.2",re._e=[],re._c={},re.ready=function(e){re.listener("load",e)},re.$=function(e){return re.$._[e]=re.$._[e]||(e.charAt(0)=="#"?document.getElementById(e.substr(1)):document.getElementsByTagName(e)[0])},re.$._={},re.$new=function(e){return document.createElement(e)},re.listener=function(e,t,n){(n||window).addEventListener(e,t,!0)},re.is=function(e,t){return arguments.length==1?e!=null:e!=null&&Object.prototype.toString.call(e).slice(8,-1).toLowerCase()==t.toLowerCase()},re.comp=re.c=function(e){return re._c[e]||(re._c[e]=new re.c.init(e)),re._c[e]},re.c.init=function(e){this.name=e,this._re_listens={},this._re_defaults={},this._re_defines={},this._re_events={},this._re_final=0;if(!re[this.name]){var t=this;re[this.name]=function(){return t._re_method.apply(t,arguments)}}},re.c.init.prototype={z:function(e,t){return this._checkFinal(),this[e]||(this[e]=[]),re.is(t,"string")?this[e]=this[e].concat(t.split(" ")):this[e]=this[e].concat(t),this},_checkFinal:function(){if(this._re_final)throw this.name+" is final."},statics:function(e,t){this._checkFinal();if(!re.is(t))for(var n in e)re[this.name][n]=e[n];else re[this.name][e]=t;return this},events:function(e,t){this._checkFinal();if(!re.is(t))for(var n in e)this._re_events[n]=e[n];else this._re_events[e]=t;return this},factory:function(e){return this._checkFinal(),this._re_factory=e,this},_re_method:function(){var e=re.e(this.name);return this._re_factory&&this._re_factory.apply(e,arguments),e},method:function(e){return this._re_method=e,this},requires:function(e){return this.z("_re_requires",e)},asserts:function(e){return this.z("_re_asserts",e)},interfaces:function(e){return this.z("_re_interfaces",e)},alias:function(e){this._checkFinal();var t=e.split(" ");if(t.length>1){for(var n in t)this.alias(t[n]);return this}return e.charAt(0)=="-"?re._c[e.substr(1)]==this&&delete re._c[e.substr(1)]:re._c[e]=this,this},on:function(){return re.e.init.prototype.on.apply(this,arguments)},off:function(){return re.e.init.prototype.off.apply(this,arguments)},trigger:function(){return re.e.init.prototype.trigger.apply(this,arguments)},defaults:function(e,t){this._checkFinal();if(arguments.length==1)for(var n in e)this._re_defaults[n]=e[n];else this._re_defaults[e]=t;return this},namespaces:function(e,t){this._checkFinal();var n=this.name+"_";if(arguments.length==1)for(var r in e)this._re_defines[n+r]=e[r];else this._re_defines[n+e]=t;return this},defines:function(e,t){this._checkFinal();if(arguments.length==1)for(var n in e)this._re_defines[n]=e[n];else this._re_defines[e]=t;return this},init:function(e){return this._checkFinal(),this._re_init=e,this},dispose:function(e){return this._checkFinal(),this._re_dispose=e,this},lock:function(){return this._checkFinal(),this._re_final=1,this},run:function(e){return this._checkFinal(),e.call(this),this}},function(e){var t=function(t,n,r){if(!n){var i=new e.entity.init(t);return r||e._e.push(i),i}var s=e();for(var o=0;o<n;o++)s.push(e.e(t,0,r));return s},n=function(e){this._re_comps=[],this._re_listens={},this.comp(e)},r=n.prototype;r.comp=function(e){this._re_comp(e);if(this._re_interfaces)for(var t in this._re_interfaces)if(!this.hasOwnProperty(this._re_interfaces[t]))throw"Interface: "+this._re_interfaces[t]+" missing";if(this._re_asserts)for(var n in this._re_asserts)if(this._re_comps.indexOf(this._re_asserts[n])!=-1)throw"Assert: "+this._re_asserts[n]+" is not allowed";return this},r.removeComp=function(t){var n;e.is(t,"array")?n=t:n=t.split(" ");if(n.length>1){var r;while(r=n.shift())this.removeComp(r);return this}t=n[0];if(t&&this.has(t)){var i=e._c[t];i&&(i._re_dispose&&i._re_dispose.call(this,i),i.trigger("dispose",this)),this._re_comps.splice(this._re_comps.indexOf(t),1)}return this},r._re_comp=function(t){if(!t)return this;var n;e.is(t,"array")?n=t:n=t.split(" ");if(n.length>1){for(var r=0;r<n.length;r++)this._re_comp(n[r]);return this}t=n[0];if(!t)return this;var i,s=t.split(":");return t=s[0],s.shift(),i=e._c[t],this.has(t)||(this._re_comps.push(t),i&&(this._re_comp(i._re_requires),i._re_interfaces&&(this._re_interfaces||(this._re_interfaces=[]),this._re_interfaces=this._re_interfaces.concat(i._re_interfaces)),i._re_asserts&&(this._re_asserts||(this._re_asserts=[]),this._re_asserts=this._re_asserts.concat(i._re_asserts)),i._re_defaults&&this.def(i._re_defaults),i._re_defines&&this.attr(i._re_defines),i._re_events&&this.attr(i._re_events).on(i._re_events),i._re_init&&i._re_init.apply(this,s),i.trigger("init",this))),this},r.comps=function(){return this._re_comps.slice()},r.clone=function(t,n){return e.e(this._re_comps,t,n)},r._super=function(t,n){var r=Array.prototype.slice.call(arguments,2);if(t=="")return e.e.init.prototype[n].apply(this,r);var i=e._c[t];return i._re_defines[n]?i._re_defines[n].apply(this,r):i._re_defaults[n].apply(this,r)},r.has=function(t){e.is(t,"string")&&(t=e.query._toObj(t)),t.comp=t.comp||[],t.id=t.id||"",t.on=t.on||[],t.not=t.not||[];for(r=0;r<t.comp.length;r++)if(this._re_comps.indexOf(t.comp[r])==-1)return!1;for(r=0;r<t.not.length;r++)if(this._re_comps.indexOf(t.not[r])!=-1)return!1;var n;for(r=0;r<t.on.length;r++){n=t.on[r];if(!this._re_listens[n]||this._re_listens[n].length==0)return!1}return t.id!=""&&this.id!=t.id?!1:!0},r.on=function(t,n,r){if(e.is(t,"object"))for(var i in t)this.on(i,t[i],n);else{this._re_listens[t]||(this._re_listens[t]=[]);if(!e.is(n))throw"Method is null";this._re_listens[t].push({c:r||this,f:n})}return this},r.off=function(t,n){if(e.is(t,"object"))for(var r in t)t.hasOwnProperty(r)&&this.off(r,t[r]);else if(n){var i=this._re_listens[t];for(var r in i)i[r].f==n&&i.splice(r,1)}else t?this._re_listens[t]=[]:this._re_listens={};return this},r.trigger=function(e){if(!this._re_listens[e])return this;var t;for(var n=0,r=this._re_listens[e].length;n<r;n++){t=this._re_listens[e];if(!t)break;if(!t[n])continue;t[n].f.apply(t[n].c,Array.prototype.slice.call(arguments,1))===!1&&t.splice(n,1)}return this},r.attr=r.set=function(t,n){if(e.is(t,"object"))for(var r in t)this.attr(r,t[r]);else{var i="function";e.is(this[t],i)&&!e.is(n,i)?e.is(n,"array")?this[t].apply(this,n):this[t].call(this,n):this[t]=n}return this},r.get=function(t){return e.is(this[t],"function")?this[t]():this[t]},r.def=function(t,n){if(e.is(t,"object"))for(var r in t)this.def(r,t[r]);else e.is(this[t])||(this[t]=n);return this},r.dispose=function(){var t="dispose";return this.removeComp(this.comps()),this.trigger(t),this.off(),e._e.splice(e._e.indexOf(this),1),this},e.entity=e.e=t,e.entity.init=n}(re),function(e){var t=function(t){return new e.load.init(t)};t.path="",t.imageExt="img",t.soundExt="sfx",t.images=["gif","jpg","jpeg","png"],t.sounds=["wav","mp3","aac","ogg"];var n=function(t){if(e.is(t,"string"))this.assets=t.split(" ");else if(e.is(t,"object")){this.assets=[];for(var n in t)e.is(t[n],"array")&&(this.assets=this.assets.concat(t[n]))}else this.assets=t;var r;for(var n=0;n<this.assets.length;n++){this.total++,r=this.assets[n];var i=r,s=r.lastIndexOf("/");s!=-1&&(r=r.substr(s+1,r.length));var o=r.lastIndexOf(".")+1,u=r.substr(o).toLowerCase(),a=r.substr(0,o);if(e.load.images.indexOf(u)!=-1)this._loadImg(i,r,a);else if(e.load.sounds.indexOf(u)!=-1){if(!(window.soundManager&&u=="mp3"||e.support(u))){this.total--;continue}if(e._c[a+e.load.soundExt]){this.total--;continue}this._loadSound(i,r,a)}}return this},r=n.prototype;r.current=0,r.total=0,r._loadImg=function(t,n,r){var i=this,s=new Image;return e.c(n).alias(r+e.load.imageExt).defines({_image:s}).image=s,s.onload=function(){e.c(n).defines({sizeX:s.width,sizeY:s.height,bisect:s.width}),i._loaded()},s.onerror=function(){i._e&&i._e.call(i,n)},s.src=e.load.path+t,this},r._loaded=function(){this.current++,this.current<=this.total&&this._p&&this._p(this.current,this.total,this.assets[this.current-1]),this.current==this.total&&this._s&&this._s(this.assets)},r._loadSound=function(t,n,r){var i=this,s;if(window.soundManager)soundManager.onready(function(){s=soundManager.createSound({id:n,url:e.load.path+t,autoLoad:!0,onload:function(){i._loaded()}}),i._def_sfx(s,n,r)});else{s=new Audio(e.load.path+t),s.src=e.load.path+t,s.preload="auto",s.load();var o=function(){i._loaded(),s.removeEventListener("canplaythrough",o)};s.addEventListener("canplaythrough",o,!1),s.addEventListener("error",function(){i._e&&i._e.call(i,n)},!1),this._def_sfx(s,n,r)}},r._def_sfx=function(t,n,r){e.c(n).alias(r+e.load.soundExt).defines({_sound:t}).sound=t},r.progress=function(e){return this._p=e,this},r.complete=function(e){return this._s=e,this.assets.length==0&&e([]),this},r.error=function(e){return this._e=e,this},e.load=t,e.load.init=n}(re),function(e){var t=function(e){e&&this.query(e)};t._toObj=function(e){if(t.c[e])return t.c[e];var n=e.split(" "),r=[],i=[],s=[],o="",u,a;for(var f=n.length;f--;)u=n[f].charAt(0),a=n[f].substr(1),u=="^"?i.push(a):u=="!"?s.push(a):u=="#"?o=a:r.push(n[f]);var l={comp:r,on:i,not:s,id:o};return t.c[e]=l,l},t.c={};var n=t.prototype=new Array;n.query=function(n){n=n||"";var r=e._e.length,i=-1,s;if(e.is(n,"string")){if(n=="*")return this.push.apply(this,e._e.slice()),this;var o=t._toObj(n);while(++i<r&&(s=e._e[i]))s.has(o)&&this.push(s)}else if(e.is(n,"function"))while(++i<r&&(s=e._e[i]))n.call(s,i,r)&&this.push(s);else e.is(n,"array")&&this.push.apply(this,n);return this},n.invoke=function(e){var t=Array.prototype.slice.call(arguments,1);return this.each(function(n){n[e].apply(n,t)})},n.each=function(e,t){var n=this.length,r=-1,i;while(++r<n&&(i=this[r])!=null&&e.call(t||this,i,r,this)!==!1);return this},n.tilemap=function(e,t,n){var r=0,i=0;return this.each(function(s,o){if(t.call(n,this[s],r,i,s,this)==0)return!1;r++,r==e&&(r=0,i++)})},n.comps=function(){var e=[];return this.each(function(t){var n=t.comps();for(var r=0;r<n.length;r++)e.indexOf(n[r])==-1&&e.push(n[r])}),e},n.random=function(){return this[Math.random()*this.length|0]},n.attr=function(e,t){return this.invoke("attr",e,t)},n.def=function(e,t){return this.invoke("def",e,t)},n.comp=function(e){return this.invoke("comp",e)},n.removeComp=function(e){return this.invoke("removeComp",e)},n.on=function(e,t){return this.invoke("on",e,t)},n.off=function(e,t){return this.invoke("off",e,t)},n.trigger=function(){var e=arguments;return this.each(function(t){t.trigger.apply(t,e)})},n.has=function(e){return this.length?this.every(function(t){return t.has(e)}):!1},n.pluck=function(e){var t=[],n=e.split(" ");return this.each(function(e){var r={};for(var i in n){var s=n[i];r[s]=e[s]}t.push(r)}),t},n.isEmpty=function(){return!this.length},n.find=function(e,t){for(var n=0,r=this.length;n<r;n++)if(e.call(t||this,this[n],n,this))return this[n];return null},n.min=function(e,t){var n=Infinity,r;return this.each(function(i,s,o){var u=e.call(t||this,i,s,o);u<n&&(n=u,r=i)}),r},n.max=function(e,t){var n=-Infinity,r;return this.each(function(i,s,o){var u=e.call(t||this,i,s,o);u>n&&(n=u,r=i)}),r},n.filter=function(){return e(Array.prototype.filter.apply(this,arguments))},n.reject=function(e,t){for(var n=0;n<this.length;n++)e.call(t||this,this[n],n,this)&&this.splice(n,1);return this},n.findWith=function(e){return this.find(function(t){return t.has(e)})},n.e=function(t,n,r){var i=e.e(t,n,r);if(n)for(var s in i)this.push(i[s]);else this.push(i);return this},n.include=function(e){return this.indexOf(e)!=-1},n.erase=function(e){for(var t=this.length;t--;)this[t]==e&&this.splice(t,1);return this},n.insertAfter=function(e,t){return this.splice(this.indexOf(e)+1,0,t),this},n.insertBefore=function(e,t){return this.splice(this.indexOf(e),0,t),this},n.swap=function(e,t){var n=this.indexOf(e),r=this.indexOf(t),i=this[n];return this[n]=t,this[r]=i,this},n.dispose=function(){return this.each(function(e){e.dispose()})},n.first=function(e){return arguments.length?(this.unshift.apply(this,arguments),this):this[0]},n.last=function(e){return arguments.length?(this.push.apply(this,arguments),this):this[this.length-1]},e.query=t}(re),re.c("system").defaults({clearColor:"#f9f9f9",stepSize:.03,maxTick:.05,running:!1,sizeX:10,sizeY:10}).defines({clear:function(e){return e?(this.context.fillStyle=e,this.context.fillRect(0,0,this.sizeX,this.sizeY)):this.context.clearRect(0,0,this.sizeX,this.sizeY),this},start:function(){if(!this.running){this.running=!0;var e=this;(function t(){e.system_loop(),e.running&&e.requestAnimationFrame(t,e.canvas)})()}return this},loop:function(e){return this.system_loop=e,this},stop:function(){return this.running=!1,this},init:function(e,t){this.comp("polyfill tick timestep"),re.is(e,"htmlcanvaselement")?this.canvas=e:this.canvas=re.$(e),this.context=this.canvas.getContext(t||"2d");var n=re.screen=re.e("screen");return this.sizeX=n.sizeX=this.canvas.width,this.sizeY=n.sizeY=this.canvas.height,re.keyboard&&re.keyboard.i(),re.mouse&&re.mouse.i(),re.touch&&re.touch.i(),this.system_loop=this.defaultLoop,this.second=this.stepSize*30,this},defaultLoop:function(){this.timestep(Math.min(this.tick()/1e3,this.maxTick),function(){this.update()}),this.clear(this.clearColor),this.draw()},update:function(){re.update.update(this.stepSize)},draw:function(){re.drawlist().drawlist(this.context)}}),re.system=re.sys=re.e("system"),re.c("drawlist").method(function(e){var e=e||"";return re.drawlist._lists[e]||re.e("drawlist:"+e),re.drawlist._lists[e]}).statics({_lists:{}}).defines({add:function(e){return e.drawlist&&e.drawlist.remove(e),e.drawlist=this,this.list.last(e),this},remove:function(e){return e.drawlist&&(this.list.erase(e),e.drawlist=null),this},drawlist:function(e){var t=this.list;for(var n=0,r;n<t.length;n++)r=t[n],r.visible()&&r.render(e)},sort:function(){this.list.sort(function(e,t){return e.depth&&t.depth?e.depth()-t.depth():0})}}).init(function(e){re.drawlist._lists[e]=this,this.listName=e,this.list=re()}).dispose(function(){delete re.drawlist._lists[this.listName]}),re.c("tick").init(function(){this.lastTime=Date.now()}).defines({tick:function(){var e=Date.now(),t=this.lastTime;return this.lastTime=e,e-t}}),re.c("tween").requires("update").namespaces({update:function(e){if(!this.tweening)return;this.tween_time+=e;var t=this.tween_time/this.tween_t;t>1&&(t=1),value=this.tweenEase(t);for(var n in this.tween_d){var r=this.tween_s[n]+this.tween_d[n]*value;re.is(this[n],"function")?this[n](r):this[n]=r}this.trigger("tween:update",value),t==1&&(this.tweening=!1,this.off("update",this.tween_update),this.trigger("tween:finish"))}}).defaults({tweening:!1,tweenEase:function(e){return e}}).defines({tween:function(e,t){e>=100&&(e/=1e3);var n=(e||1)/re.sys.second;this.tween_time=0;var r={},i={};for(var s in t){var o=this[s];re.is(o,"function")&&(o=o()),r[s]=t[s]-o,i[s]=o}return this.tween_s=i,this.tween_d=r,this.tween_t=n,this.tweening||this.on("update",this.tween_update),this.tweening=!0,this.trigger("tween:start",i)}}),re.tween=function(e,t,n){return e.comp("tween").tween(t,n)},re.c("update").statics({l:[],update:function(e){var t=this.l;for(var n=0,r;n<t.length;n++)r=t[n],r&&r.updatable&&r.trigger("update",e)}}).defaults({updatable:!0}).defines(function(){var e=re.update.l;return{updateFirst:function(){return e.splice(e.indexOf(this),1),e.unshift(this),this},updateLast:function(){return e.splice(e.indexOf(this),1),e.push(this),this},updateAfter:function(t){var n=e.indexOf(t),r=e.indexOf(this);if(n>r){var i=e[n];e[n]=e[r],e[r]=i}return this},updateBefore:function(t){var n=e.indexOf(t),r=e.indexOf(this);if(n<r){var i=e[n];e[n]=e[r],e[r]=i}return this}}}()).init(function(){re.update.l.push(this)}).dispose(function(){re.update.l.splice(re.update.l.indexOf(this),1)}),re.c("wait").defines({wait:function(e,t){return t=t||1e3,t<100&&(t*=1e3),setTimeout(e,t),this}}),re.c("align").defaults({regX:0,regY:0,sizeX:1,sizeY:1,posX:0,posY:0}).defines({align:function(e,t){return this.alignHor(e),this.alignVer(t)},alignHor:function(e){return e=e||0,this.set("posX",re.sys.sizeX*.5-(this.get("sizeX")-this.get("regX"))*.5+e|0),this},alignVer:function(e){return e=e||0,this.set("posY",re.sys.sizeY*.5-(this.get("sizeY")-this.get("regY"))*.5+e|0),this},alignRight:function(e){return e=e||0,this.set("posX",re.sys.sizeX-(this.get("sizeX")-this.get("regX"))+e|0),this},alignLeft:function(e){e=e||0;var t=this.get("sizeX");return this.set("posX",e+t-(t-this.get("regX"))|0),this},alignTop:function(e){e=e||0;var t=this.get("sizeY");return this.set("posY",e+t-(t-this.get("regY"))|0),this},alignBottom:function(e){return e=e||0,this.set("posY",re.sys.sizeY-(this.get("sizeY")-this.get("regY"))+e|0),this}}),re.c("animate").requires("flicker").defines({flicker_stop:function(){this._super("flicker","flicker_stop"),this.animate_finish&&this.animate_finish()},animate:function(e,t,n){if(this.flickering()!=e){this.animate_finish=t,this.animate_update=n;var r=this.animates[e];this.flicker(r[0],r[1],r[2],e),r.push&&this.flicker_run()}return this},animating:function(e){return this.flickering(e)},flick:function(e){this.frame(e),this.animate_update&&this.animate_update.apply(this,arguments)}}),re.c("circle").requires("draw").defaults({color:"#82d5f4"}).defines({draw:function(e){e.fillStyle=this.color,e.beginPath();var t=this.radius();return e.arc(-this.regX+t,-this.regY+t,t,0,Math.PI*2,!0),e.closePath(),e.fill(),this},radius:function(e){return re.is(e)?(this.sizeX=this.sizeY=e*2,this):this.sizeX*.5}}),re.c("draw").interfaces("draw").init(function(){re.drawlist().add(this)}).dispose(function(e){this.drawlist.remove(this)}).defaults({screenable:!0,drawable:!0,rotation:0,alpha:1,scaleX:1,scaleY:1,posX:0,posY:0,sizeX:10,sizeY:10,regX:0,regY:0}).defines({depth:function(){return this.posY},drawFirst:function(){var e=this.drawlist.list;return e.splice(e.indexOf(this),1),e.unshift(this),this},drawLast:function(){var e=this.drawlist.list;return e.splice(e.indexOf(this),1),e.push(this),this},drawAfter:function(e){var t=this.drawlist.list,n=t.indexOf(e),r=t.indexOf(this);if(n>r){var i=t[n];t[n]=t[r],t[r]=i}return this},drawBefore:function(e){var t=this.drawlist.list,n=t.indexOf(e),r=t.indexOf(this);if(n<r){var i=t[n];t[n]=t[r],t[r]=i}return this},screenX:function(e){return e?(this.posX=e+re.screen.posX,this):this.posX-re.screen.posX},screenY:function(e){return e?(this.posY=e+re.screen.posY,this):this.posY-re.screen.posY},render:function(e){this.draw_before(e),this.draw(e),this.draw_after(e)},visible:function(){return this.drawable&&re.screen.hit(this.posX-this.regX,this.posY-this.regY,this.sizeX,this.sizeY)}}).namespaces({before:function(e){e.save(),this.alpha-1&&(e.globalAlpha=this.alpha),this.screenable?e.translate(this.screenX(),this.screenY()):e.translate(this.posX,this.posY),this.rotation&&e.rotate(this.rotation*Math.PI/180),(this.scaleX!=1||this.scaleY!=1)&&e.scale(this.scaleX,this.scaleY)},after:function(e){e.restore()}}),re.c("el").requires("align").defines({posX:function(e){return re.is(e)?this.$el.css("left",e):this.$el.position().left},posY:function(e){return re.is(e)?this.$el.css("top",e):this.$el.position().top},sizeX:function(){return this.$el.outerWidth()},sizeY:function(){return this.$el.outerHeight()},click:function(e){var t=this;return this.$el.click(function(n){return e.call(t,n),!1}),this},$:function(e,t){return this.$el.find(e,t)},setEl:function(e){return this.remove(),this.el=e,this.$el=$(e).addClass("el"),this.posX(0),this.posY(0),this},text:function(e){return re.is(e)?(this.$el.text(e),this):this.$el.text()},place:function(){return $(re.sys.canvas).parent().append(this.el),this},remove:function(){return this.$el&&(this.$el.remove(),this.$el=this.el=null),this},hide:function(){return this.$el.hide(),this},show:function(){return this.$el.show(),this}}).init(function(e){e&&this.setEl(re.$new(e))}).dispose(function(){this.remove()}),re.c("group").defaults({posX:0,posY:0}).defines({group:function(){for(var e=0;e<arguments.length;e++)arguments[e].comp("group").group},ungroup:function(e){},getScreenX:function(){var e=this.posX;return this.group&&(e+=this.group.posX),this.screen&&(e+=this.screen.posX),e},getScreenY:function(){var e=this.posY;return this.group&&(e+=this.group.posY),this.screen&&(e+=this.screen.posY),e},getGroupX:function(){var e=this.posX;return this.group&&(e+=this.group.posX),e},getGroupY:function(){var e=this.posY;return this.group&&(e+=this.group.posY),e},setGroupX:function(e){},setGroupY:function(e){}}),re.c("image").requires("draw").defines({image:function(e){return re.is(e)?(this.attr({_image:e,sizeX:e.width,sizeY:e.height}),this):this._image},visible:function(){return this._image&&this._super("draw","visible")},draw:function(e){return e.drawImage(this._image,-this.regX,-this.regY,this.sizeX,this.sizeY),this}}).init(function(){this._image&&this.image(this._image)}),re.c("imgtext").requires("draw").interfaces("imgtext").defaults({charOffset:32,lineHeight:15}).defines({visible:function(){return this._text&&this._image&&this._super("draw","visible")},draw:function(e){for(var t=0;t<this.text_lines.length;t++)this.drawText(e,this.text_lines[t],t*this.lineHeight);return this},drawText:function(e,t,n){var r=0,i,s,o;for(var u=0,a=t.length;u<a;++u){s=t.charCodeAt(u)-this.charOffset,i=this.imgtext[s];if(!this.charCache[s]){o=0;for(var f=0;f<s;++f)o+=this.imgtext[f]+1;this.charCache[s]=o}e.drawImage(this._image,this.charCache[s],0,i,this._image.height,-this.regX+r,-this.regY+n,i,this._image.height),r+=i}},text:function(e){if(re.is(e)){this._text=e,this.text_lines=this._text.split("\n"),this.sizeX=0;for(var t in this.text_lines){var n=0;for(var r=0;r<this.text_lines[t].length;r++)n+=this.imgtext[r];n>this.sizeX&&(this.sizeX=n)}return this.sizeY=this.text_lines.length*this.lineHeight,this}return this._text}}).init(function(){this.charCache||(this.charCache={}),this.text("")}),re.c("rect").requires("draw").defaults({color:"#82d5f4"}).defines({draw:function(e){return e.fillStyle=this.color,e.fillRect(-this.regX,-this.regY,this.sizeX,this.sizeY),this}}),re.c("screen").requires("hit").defines({pos:function(e,t){return arguments.length?(re.is(e,"object")&&(t=e.posY,e=e.posX),this.posX=e-this.regX,this.posY=t-this.regY,this):this},toScreenX:function(e){return e+this.posX+this.offX},toScreenY:function(e){return e+this.posY+this.offY}}).defaults({posX:0,posY:0,regX:0,regY:0,sizeX:0,sizeY:0,offX:0,offY:0}),re.c("sprite").requires("image bisect").defaults({frameX:0,frameY:0}).defines({frame:function(e){return re.is(e)?(this.frameX=this.biToTileX(e),this.frameY=this.biToTileY(e),this):this.tileToBi(this.frameX,this.frameY)},draw:function(e){return e.drawImage(this._image,this.frameX*this.sizeX,this.frameY*this.sizeY,this.sizeX,this.sizeY,-this.regX,-this.regY,this.sizeX,this.sizeY),this}}),re.c("text").requires("draw").defaults({font:"14px sans-serif",textColor:"#000000",textAlign:"left",textBaseline:"top",lineHeight:15}).defines({visible:function(){return this._text&&this._super("draw","visible")},text:function(e){if(re.is(e)){e=Array.prototype.join.call(arguments," "),this.text_lines=e.split("\n"),this._text=e;if(re.sys.context){var t=re.sys.context;t.save(),t.font=this.font,this.sizeX=0;var n=0;for(var r in this.text_lines)n=t.measureText(this.text_lines[r]).width,n>this.sizeX&&(this.sizeX=n);t.restore()}return this.sizeY=this.text_lines.length*this.lineHeight,this}return this._text},draw:function(e){e.font=this.font,e.fillStyle=this.textColor,e.textAlign=this.textAlgin,e.textBaseline=this.textBaseline;var t=this.text_lines;for(var n=0,r=t.length;n<r;n++)e.fillText(t[n],-this.regX,-this.regY+n*this.lineHeight);return this}}),re.c("keyboard").statics({l:[],keyCodes:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",16:"shift",17:"ctrl",18:"alt",24:"cmd",255:"fn",8:"backspace",13:"enter",32:"space",27:"esc",9:"tab",20:"capslock",91:"windows",46:"delete",36:"home",35:"end",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",96:"`",45:"-",187:"=",219:"[",221:"]",220:"\\",59:";",222:"'",188:",",190:".",191:"/"},event:function(e){var t=re.keyboard,n=(e.target||e.srcElement||{}).tagName;if(n=="INPUT"||n=="SELECT"||n=="TEXTAREA")return;var r=e.keyCode||e.which,i=t.keyCodes[r];re.pressed&&re.pressed.d&&(re.pressed.d[i]=e.type=="keydown"),re.preventDefault&&re.preventDefault.d[i]&&e.preventDefault();for(var s=0;s<t.l.length;s++)t.l[s].trigger(e.type,i,e).trigger(e.type+":"+i,i,e)},i:function(){re.listener("keydown",this.event),re.listener("keyup",this.event),re.listener("focus",function(){re.pressed.d={}})}}).init(function(){re.keyboard.l.push(this)}).dispose(function(){re.keyboard.l.splice(re.keyboard.l.indexOf(this),1)}),re.c("mouse").statics({l:[],press:function(e){var t,n;e.which==null?e.button<2?t="left":e.button==4?t="middle":t="right":e.which<2?t="left":e.which==2?t="middle":t="right",n="mouse:"+t,re.pressed.d&&(re.pressed.d[n]=e.type=="mousedown"),re.mouse.event(e,n)},event:function(e,t){var n=re.sys.canvas,r=n.width/n.offsetWidth,i=n.height/n.offsetHeight;e.offsetX!=null?(r*=e.offsetX,i*=e.offsetY):(r*=e.layerX-n.offsetLeft,i*=e.layerY-n.offsetTop);var s=re.mouse.l,o,u,a,f,l;for(var c=0;c<s.length;c++)u=s[c],u.screenable?(f=re.screen.toScreenX(r),l=re.screen.toScreenY(i)):(f=r,l=i),f+=u.offX,l+=u.offY,u.trigger(e.type,f,l,e),t&&u.trigger(e.type+":"+t,f,l,e)},i:function(){var e=re.sys.canvas;re.listener("mousedown",this.press,e),re.listener("mouseup",this.press,e),re.listener("mousemove",this.event,e),re.listener("mouseover",this.event,e),re.listener("mouseout",this.event,e),re.listener("click",this.event,e),re.listener("dblclick",this.event,e),re.listener("contextmenu",this.event,e)}}).defaults({offX:0,offY:0}).init(function(){re.mouse.l.push(this)}).dispose(function(){re.mouse.l.splice(re.mouse.l.indexOf(this),1)}),re.pressed=function(e){var t=arguments;re.is(e,"array")&&(t=e);for(var n=0,r=t.length;n<r;n++)if(re.pressed.d[t[n]])return!0;return!1},re.pressed.d={},re.preventDefault=function(e){re.is(e,"string")&&(e=e.split(" "));for(var t in e)re.preventDefault.d[e[t]]=1},re.preventDefault.d={},re.c("bisect").statics({toX:function(e,t,n){return this.toTileX(e,t,n)*n},toY:function(e,t,n){return this.toTileY(e,t,n)*n},toTileX:function(e,t,n){return e%(t/n)|0},toTileY:function(e,t,n){return e*n/(t-.1)|0},tileToBi:function(e,t,n,r){return e+t*(n/r)}}).defines({biToX:function(e){return re.bisect.toX(e,this.bisect,this.sizeX)},biToY:function(e){return re.bisect.toY(e,this.bisect,this.sizeX)},biToTileX:function(e){return re.bisect.toTileX(e,this.bisect,this.sizeX)},biToTileY:function(e){return re.bisect.toTileY(e,this.bisect,this.sizeX)},tileToBi:function(e,t){return re.bisect.tileToBi(e,t,this.bisect,this.sizeX)}}).defaults({bisect:1,sizeX:1,sizeY:1}),re.c("body").defines({hit:function(e,t,n,r,i,s){re.is(e,"object")&&(t=e.posY||e.y,n=e.sizeX||e.w,r=e.sizeY||e.h,i=e.regX||0,s=e.regY||0,e=e.posX||e.x),i=i||0,s=s||0;var o=this.regX||0,u=this.regY||0;return!(e-i>this.posX+this.bodyX-this.padX-o||e+n-i<this.posX+this.padX-o||t-s>this.posY+this.bodyY-this.padY-u||t+r-s<this.posY+this.padY-u)},hitBody:function(e,t,n,r,i,s,o,u){re.is(e,"object")&&(t=e.posY||e.y,n=e.bodyX,r=e.bodyY,i=e.padX,s=e.padY,o=e.regX||0,u=e.regY||0,e=e.posX||e.x),o=o||0,u=u||0;var a=this.regX||0,f=this.regY||0;return!(e+i-o>this.posX+this.bodyX+this.padX-a||e+n-i-o<this.posX+this.padX-a||t+s-u>this.posY+this.bodyY-this.padY-f||t+r-s-u<this.posY+this.padY-f)}}).defaults({posX:0,posY:0,padX:0,padY:0,bodyX:1,bodyY:1}),re.distance=function(e,t,n,r){var i,s;return i=n-e,s=r-t,Math.sqrt(i*i+s*s)},re.c("drag").defaults({posX:0,posY:0,dragX:0,dragY:0,dragging:!1}).defines({dragStart:function(e,t){return this.dragging||(this.dragging=!0,this.dragX=e,this.dragY=t,this.trigger("drag:start")),this},dragFinish:function(){return this.dragging=!1,this.trigger("drag:finish")},dragUpdate:function(e,t){return this.dragging&&(this.posX+=e-this.dragX,this.posY+=t-this.dragY,this.dragX=e,this.dragY=t,this.trigger("drag:update")),this}}),re.c("force").requires("update").statics({graX:0,graY:0}).defaults({posX:0,posY:0,velX:0,velY:0,friX:.4,friY:.4,accX:0,accY:0,resX:.4,resY:.4,mass:1}).namespaces({update:function(){this.velX=this.force(this.velX,this.accX,this.friX,this.graX,this.mass),this.velY=this.force(this.velY,this.accY,this.friY,this.graY,this.mass),this.hitmap?this.aftermath(this.hitmap.checkHit(this)):this.aftermath(this.posX+this.velX,this.posY+this.velY)}}).defines({aftermath:function(e,t,n,r,i,s){return re.is(e,"object")&&(n=e.hitX,r=e.hitY,i=e.tarX,s=e.tarY,t=e.posY,e=e.posX),this.posX=e,this.posY=t,n&&(this.velX=this.forceRes(this.velX,this.resX)),r&&(this.velY=this.forceRes(this.velY,this.resY)),this.trigger("aftermath",n,r,i,s)},forceRes:function(e,t){return e*-t},forceGra:function(e,t){return e*t},forceVel:function(e,t,n){return(e+t)*n},force:function(e,t,n,r,i){var s=this.forceVel(e,t,n)+this.forceGra(r,i);return Math.abs(s)<.01&&(s=0),s},isIdle:function(e){return e=e||0,Math.abs(this.velY+this.velX+this.accX+this.accY)<=e}}).init(function(){this.def({hitmap:re.hitmap,graX:re.force.graX,graY:re.force.graY}),this.on("update",this.force_update)}).dispose(function(){this.off("update",this.force_update)}),re.c("hit").defaults({posX:0,posY:0,sizeX:1,sizeY:1,hit:function(e,t,n,r,i,s){re.is(e,"object")&&(t=e.posY||e.y,n=e.sizeX||e.w,r=e.sizeY||e.h,i=e.regX||0,s=e.regY||0,e=e.posX||e.x),i=i||0,s=s||0;var o=this.regX||0,u=this.regY||0;return!(e-i>this.posX+this.sizeX-o||e+n-i<this.posX-o||t-s>this.posY+this.sizeY-u||t+r-s<this.posY-u)}}),re.c("hitmap").requires("automap").defines({hitValue:1,checkAxisX:function(e,t,n,r,i){return e==this.hitValue},checkAxisY:function(e,t,n,r,i){return e==this.hitValue},checkHit:function(e,t,n,r,i,s,o,u){re.is(e,"object")&&(n=e.velX,r=e.velY,i=e.bodyX||e.sizeX,s=e.bodyY||e.sizeY,o=e.padX||0,u=e.padY||0,t=e.posY,e=e.posX);var a={posX:e,posY:t},f=Math.max(Math.abs(n),Math.abs(r))/((re.tile.sizeX+re.tile.sizeY)*.5)+.5|0;if(f>1){var l=n/f,c=r/f;for(var h=0;h<f&&(l||c);h++)this.hitmap_step(a,e,t,l,c,i,s,u,u),a.hitX&&(l=0),a.hitY&&(c=0)}else this.hitmap_step(a,e,t,n,r,i,s,o,u);return a}}).namespaces({step:function(e,t,n,r,i,s,o,u,a){e.posX+=r,e.posY+=i;var f,l,c;if(r){f=re.tile.sizeX;var h=r>0?s-u:u,p=Math.floor((n+a)/f),d=Math.ceil((n+o-a)/f);c=Math.floor((t+r+h)/f);var v=r<0?f:0;if(c>=0&&c<this.lenX&&d>=0&&p<this.lenY)for(l=p;l<d;l++)if(this._automap[l]){this.trigger("hit",this._automap[l][c],c,l);if(this.checkAxisX(this._automap[l][c],t,n,r,i)){e.hitX=!0,e.posX=c*f+v-h,e.tarX=c*f,e.tarY=l*f;break}}}if(i){f=re.tile.sizeY;var m=i>0?o-a:a,g=Math.floor((e.posX+u)/f),y=Math.ceil((e.posX+s-u)/f);l=Math.floor((n+i+m)/f);var b=i<0?f:0;if(l>=0&&l<this.lenY&&y>=0&&g<this.lenX)for(c=g;c<y;c++)if(this._automap[l]){this.trigger("hit",this._automap[l][c],c,l);if(this.checkAxisY(this._automap[l][c],t,n,r,i)){e.hitY=!0,e.posY=l*f+b-m,e.tarX=c*f,e.tarY=l*f;break}}}}}),re.hitmap=null,re.c("iso").statics({sizeX:30,sizeY:30,sizeZ:30,toPosX:function(e,t){var n=this.toIsoX(e,t),r=this.toIsoY(e,t);return(n-r)*this.sizeX},toPosY:function(e,t){var n=this.toIsoX(e,t),r=this.toIsoY(e,t);return(n+r)*this.sizeY*.5},toPos:function(e,t){return re.is(e,"object")&&(t=e.posY||e.y,e=e.posX||e.x),{posX:this.toPosX(e,t),posY:this.toPosY(e,t)}},toIsoX:function(e,t){var n=(2*t-e)*.5,r=e+n;return Math.round(r/this.sizeX)-1},toIsoY:function(e,t){var n=(2*t-e)*.5;return Math.round(n/this.sizeY)},toIso:function(e,t){return re.is(e,"object")&&(t=e.posY||e.y,e=e.posX||e.x),{isoX:this.toIsoX(e,t),isoY:this.toIsoY(e,t)}}}).defaults({posX:0,posY:0,posZ:0}).defines({iso:function(e,t,n){if(re.is(e,"object")){n=e.z,re.is(e.posZ)&&(n=e.posZ/re.iso.sizeZ),t=e.y;if(re.is(e.posX)&&re.is(e.posY))return this.posX=e.posX,this.posY=e.posY,e.posZ&&(this.posZ=e.posZ),this;e=e.x}return e=re.is(e)?e:this.isoX(),e*=re.iso.sizeX,t=re.is(t)?t:this.isoY(),t*=re.iso.sizeY,n=re.is(n)?n:this.isoZ(),n*=re.iso.sizeZ,this.posX=e-t,this.posY=(e+t)*.5-n,this.posZ=n,this},isoX:function(e){return re.is(e)?this.iso(e):(this.posX+(2*(this.posY+this.posZ)-this.posX)*.5)/re.iso.sizeX},isoY:function(e){return re.is(e)?this.iso({y:e}):(2*(this.posY+this.posZ)-this.posX)*.5/re.iso.sizeY},isoZ:function(e){return re.is(e)?this.iso({z:e}):this.posZ/re.iso.sizeZ},onIso:function(){var e=this.isoX()+this.isoY()+this.isoZ();return(e|0)==e}}),re.c("limit").defines("limit",function(e){var t=arguments;return this[e]<t[1]?this[e]=t[1]:re.is(t[2])&&this[e]>t[2]&&(this[e]=t[2]),this}),re.c("point").defaults({posX:0,posY:0}).defines({pos:function(e,t){return re.is(e,"object")&&(t=e.posY||
e.y,e=e.posX||e.x),this.posX=e,this.posY=t,this},distance:function(e,t){return re.is(e,"object")&&(t=e.posY||e.y,e=e.posX||e.x),re.distance(this.posX,this.posY,e,t)}}),re.random=function(e,t){var n=Math.random();if(re.is(e,"array"))return e[n*e.length|0];if(re.is(e,"object")){var r;for(var i in e)if(Math.random()<1/++n||!re.is(r))r=i;return r}switch(arguments.length){case 0:return n;case 1:return n*e;case 2:return n*(e-t+1)+t}},re.randomInt=function(){return re.random.apply(this,arguments)|0},re.range=function(e,t,n){var r=[];for(var i=e||0;i<t;i+=n||1)r.push(i);return r},re.c("tile").statics({sizeX:40,sizeY:40,toPosX:function(e){return this.toTileX(e)*this.sizeX},toPosY:function(e){return this.toTileY(e)*this.sizeY},toPos:function(e,t){return re.is(e,"object")&&(t=e.posY||e.y,e=e.posX||e.x),{posX:this.toPosX(e),posY:this.toPosY(t)}},toTileX:function(e){return(e-this.sizeX*.5)/this.sizeX+.5|0},toTileY:function(e){return(e-this.sizeY*.5)/this.sizeY+.5|0},toTile:function(e,t){return re.is(e,"object")&&(t=e.posY||e.y,e=e.posX||e.x),{tileX:this.toTileX(e),tileY:this.toTileY(t)}}}).defaults({posX:0,posY:0,regX:0,regY:0}).defines({tile:function(e,t){return re.is(e,"object")&&(t=e.y||re.tile.toTileY(e.posY),e=e.x||re.tile.toTileX(e.posX)),this.tileX(e),this.tileY(t),this},tileX:function(e){return re.is(e)?(this.posX=e*this.sizeX+.5|0,this):this.posX/this.sizeX+.5|0},tileY:function(e){return re.is(e)?(this.posY=e*this.sizeY+.5|0,this):this.posY/this.sizeY+.5|0}}).init(function(){this.sizeX=re.tile.sizeX,this.sizeY=re.tile.sizeY}),re.c("playlist"),re.c("sound").statics({enabled:!0}).defaults({playing:!1}).namespaces({e:!1,ended:function(){this.trigger("sound:finish")}}).defines({play:function(){if(!this._sound||!re.sound.enabled)return this;this.playing&&this.stop();var e=this._sound,t=this;if(window.soundManager)e.play({onfinish:function(){t.sound_ended()}});else{e.currentTime=0;if(!this.sound_e){this.sound_e=!0;var n=function(){t.sound_ended(),e.removeEventListener("ended",n),t.sound_e=!1};e.addEventListener("ended",n,!1)}e.play()}return this},resume:function(){return this._sound.play(),this.playing=!0,this},pause:function(){return this._sound.pause(),this.playing=!1,this}}),re.c("automap").defaults({lenX:0,lenY:0,automapDefault:0}).defines({automap:function(e,t,n){if(re.is(e,"array")){if(t)for(var t=0;t<e.length;t++)for(var r=0;r<e[0].length;r++)this.automap(r,t,e[t][r]);else this._automap=e,e.length>0?this.lenX=e[0].length:this.lenX=0,this.lenY=e.length;return this}if(!re.is(n))return this.within(e,t)?this._automap[t][e]:null;while(t>=this._automap.length){var i=new Array(this._automap[0]);for(var s in i)i[s]=this.automapDefault;this._automap.push(i)}while(e>=this._automap[this._automap.length-1].length)for(var r=0;r<this._automap.length;r++)this._automap[r].length<=e&&this._automap[r].push(this.automapDefault);return this.lenX=this._automap[t].length,this.lenY=this._automap.length,this._automap[t][e]=n,this},within:function(e,t){return t<0||t>=this.lenY||e<0||e>=this.lenX?!1:!0}}).init(function(){this._automap=[]}),re.c("flicker").requires("update timestep").interfaces("flick").namespaces({flickering:"",stop:function(){var e=this.flicker_id;return this.flicker_id="",this.stepProgress=0,this.off("update",this.flicker_update),this.trigger("flicker:finish",e)},change:function(){if(this.flicker_frame==this.flicker_frames.length){if(!(this.flicker_loops==-1||--this.flicker_loops>=1)){this.flicker_stop();return}this.flicker_frame=0}this.flicker_run()},run:function(){var e=this.flicker_frame,t=this.flicker_frames,n=this.flicker_loops,r=t[e],i=this.flick(r,e,t,n);this.trigger("flicker:update",r,e,t,n),i===!1&&this.flicker(),this.flicker_frame++},update:function(e){this.timestep(e,this.flicker_change)}}).defines({flicker:function(e,t,n,r){return!re.is(e)&&this.flickering()?this.flicker_stop():(e>=100&&(e/=1e3),this.flicker_duration=e||1,t=re.is(t,"array")?t:[t],this.flicker_loops=n||1,this.stepProgress=0,this.stepSize=e/t.length/re.sys.second,this.flicker_frames=t,this.flicker_frame=0,this.flickering()||this.on("update",this.flicker_update),this.flicker_id=r||!0,this.trigger("flicker:start"),this)},flickering:function(e){return e?this.flicker_id==e:this.flicker_id}}),re.c("pathfind").method(function(){var e=re.e("pathfind"),t=e.pathfind.apply(e,arguments);return e.dispose(),t}).defines({pathfind_max:100,pathfind:function(e,t,n,r,i,s){this.targetX=n,this.targetY=r,this.onCheck=i,this.onTile=s,this.visit={},this.nodes=[],this.addNode(e,t,-1,-1);var o,u=0;while(this.nodes.length){o=this.nodes.shift();if(o.x==this.targetX&&o.y==this.targetY)return this.makePath(o);this.searchNodes(o.x,o.y,o.px,o.py);if(++u>=this.pathfind_max)return null}return null},searchNodes:function(e,t){this.addNode(e+1,t,e,t),this.addNode(e-1,t,e,t),this.addNode(e,t+1,e,t),this.addNode(e,t-1,e,t)},checkNode:function(){return!0},makePath:function(e){var t=[],n=0;do t[n++]=e.x,t[n++]=e.y,e=this.nodes[e.px+"_"+e.py];while(e&&e.px!=-1);return t},addNode:function(e,t,n,r){if(!this.checkNode(e,t,n,r)||this.onCheck&&!this.onCheck(e,t,n,r))return!1;var i=e+"_"+t,s=re.distance(e,t,this.targetX,this.targetY);if(!this.nodes[i]||this.nodes[i].cost>s){var o=this.nodes[i]={x:e,y:t,cost:s,px:n,py:r},u=!1;for(var a=0,f=this.nodes.length;a<f;a++)if(s<this.nodes[a].cost){this.nodes.splice(a,0,o),u=!0;break}return u||this.nodes.push(o),this.onTile&&this.onTile(e,t,n,r,s),!0}}}),re.c("timestep").defaults({stepProgress:0,stepSize:100}).defines({timestep:function(e,t,n){this.stepProgress+=e;while(this.stepProgress>=this.stepSize){t.call(n||this),this.stepProgress-=this.stepSize;if(!this.stepSize)break}}}),re.c("storage").init(function(e){this.storage=window[e+"Storage"]}).defines({length:function(){return this.storage.length},key:function(e){return this.storage.key(e)},item:function(e,t){return re.is(t)?(this.storage.setItem(e,JSON.stringify(t)),this):JSON.parse(this.storage.getItem(e))},removeItem:function(e){return this.storage.removeItem(e),this},clear:function(){return this.storage.clear(),this}}),re.clone=function(e){if(!re.is("object"))return e;if(re.is(e,"array"))return e.slice();var t={};for(var n in e)t[n]=e[n];return t},re.log=function(e){console.log(e)},re.c("polyfill").defines({requestAnimationFrame:function(e,t){return requestAnimFrame(e,t)}}).run(function(){requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}),re.c("scene").statics({_scenes:{}}).method(function(e){var t=re.scene;return re.is(e)?(t._scenes[e]||re.e("scene:"+e),t._scenes[e]):t._scenes[re.scene.current]}).init(function(e){re.scene._scenes[e]=this,this.sceneName=e}).dispose(function(){delete re.scene._scenes[this.sceneName]}).defines({clear:function(){return re("el").query("draw").dispose(),this},enter:function(e){return re.is(e,"function")?this.scene_enter=e:(re.scene.current&&re.scene().exit(),re.scene.current=this.sceneName,this.scene_enter&&this.scene_enter.apply(this,arguments)),this},exit:function(e){return re.is(e,"function")?this.scene_exit=e:(re.scene.current="",this.scene_exit&&this.scene_exit.apply(this,arguments)),this}}),re.sheet=function(e,t,n,r){var i=n||re.tile.sizeX,s=r||re.tile.sizeY;re.is(t,"array")&&(t=t.join(" "));var o,u,a=[];for(var f in e)o=e[f][0]||0,u=e[f][1]||0,a.push(f),re.c(f).requires("sprite "+t).defines({frameX:o,frameY:u,sizeX:i,sizeY:s});return a},re.support=function(e){if(arguments.length>1){var t;for(var n=0;n<arguments.length;n++){t=arguments[n];if(re.support(t))return t}return!1}var r=e.split(" "),i=!0;for(var s in r)i=i&&!!re.support[r[s]];return i};var c=re.support;c.canvas=!!document.createElement("canvas").getContext,c.text=!!c.canvas&&typeof document.createElement("canvas").getContext("2d").fillText=="function";var ele=document.createElement("audio");try{if(c.audio=!!ele.canPlayType){c.ogg=ele.canPlayType('audio/ogg; codecs="vorbis"'),c.mp3=ele.canPlayType("audio/mpeg;"),c.wav=ele.canPlayType('audio/wav; codecs="1"'),c.aac=ele.canPlayType("audio/x-m4a;")||ele.canPlayType("audio/aac;");for(var i in c)if(c[i]=="no"||c[i]=="")c[i]=!1}}catch(e){}try{c.localstorage=!!localStorage.getItem}catch(e){c.localstorage=!1}c.worker=!!window.Worker,c.webgl=!!window.WebGLRenderingContext,c.touch="ontouchstart"in window,re.c("cursor").requires("isoimage mouse").defines({frame:90,activate:function(e,t){var n=re.iso.toIso(e,t);this.moveTo(n)},hover:function(e,t){var n=re.iso.toIso(e,t);re.currentLevel.canMoveTo(n)&&(this.place(n.isoX,n.isoY),re.drawlist().sort())},moveToScene:function(e,t,n){var r=re("#player")[0];n&&r.place.apply(r,n),re.scene(e).enter(t)},moveTo:function(e){if(re.currentLevel.canMoveTo(e)){switch(re.currentLevel.action(e)){case 1:this.moveToScene("home",1,[0,0]);break;case 2:this.moveToScene("home",-1,[0,0]);break;case 9:this.moveToScene("faceOff",0,[e.isoX,e.isoY]);break;default:re("#player")[0].place(e.isoX,e.isoY)}re.drawlist().sort()}}}).init(function(){this.on({click:this.activate,mousemove:this.hover})}),re.c("isoimage").requires("iso sprite sprites.png").defines({sizeX:43,sizeY:35,layer:0,isoHeight:function(){return parseInt((this.frameX||0)/5,10)*10},action:function(){var e=this,t=re("npc").filter(function(t){if(t.isoX()===e.isoX()&&t.isoY()===e.isoY())return!0});return t.length>0?9:this.frameY||0},place:function(e,t){this.id==="player"&&(re.place=[e,t]),this.iso(e,t,re.currentLevel.tileHeight(e,t)/re.iso.sizeZ)},depth:function(){return this.posY+this.layer+this.posZ}}).init(function(){this.regY=this.sizeY-re.iso.sizeY}),re.c("npc").requires("isoimage").defines({addToLevel:function(e){var t,n,r=re("level")[e].map;while(!t)n=[randBetween(0,7),randBetween(0,7)],r[n[1]][n[0]]<5&&n[0]!==0&&n[1]!==0&&(t=n);this.attr({id:"npc"+e,frame:30+e,place:t,layer:re.layer.npc})}}),re.c("score").requires("text").defaults({money:0}).defines({addMoney:function(e){this.money+=e,re.score=this.money,this.text.attr("text","Money: €"+this.money)}}).init(function(){this.text=re.e("text").attr({font:"15px sans-serif",screen:null,posX:155,posY:5})}),re.ready(function(){re.sys.init(re.canvas).start(),re.scene("load").enter()}),re.c("conTrust").requires("text mouse").defines({level:null,characters:[{name:"Honest John",honesty:5,savvy:randBetween(1,5),risk:randBetween(50,100),reward:randBetween(50,100)},{name:"Steady Eddie",honesty:randBetween(3,5),savvy:randBetween(1,3),risk:randBetween(50,100),reward:randBetween(50,100)},{name:"Wobbly Robby",honesty:randBetween(1,5),savvy:randBetween(1,5),risk:randBetween(100,200),reward:randBetween(100,200)},{name:"Diamond Geezer",honesty:randBetween(1,3),savvy:4,risk:randBetween(200,300),reward:randBetween(200,300)},{name:"Tricky Dicky",honesty:1,savvy:randBetween(3,5),risk:randBetween(300,500),reward:randBetween(300,500)}],stories:["I'll give you €REWARD if you deliver this €RISK to my brother","This lottery ticket won €REWARD but you can buy it for €RISK","I'm lost, give me €RISK and I'll send €REWARD when I get home","The mountains are full of gold. €RISK will earn you €REWARD","The fix is in: put €RISK on number five for a sure €REWARD!","These speakers will go for €REWARD, just €RISK for the lot","My father's ransom is €RISK; he'll pay €REWARD if you help","I have €REWARD in coins that I can't change - €RISK to you"],chooseStory:function(e,t){return this.stories[randBetween(0,this.stories.length-1)].replace("RISK",e).replace("REWARD",t)},title:function(e){return re.e("text").attr({text:e,font:"40px sans-serif",posX:-200}),this},description:function(e){return re.e("text").attr({text:e,font:"15px sans-serif",posX:-200,posY:50}),this},story:function(e){return re.e("text").attr({text:e,font:"15px sans-serif",posX:-200,posY:75}),this},conButton:function(){return re.e("rect").attr({color:"#a00",posY:130,posX:-220,sizeX:230,sizeY:120}),re.e("text").attr({text:"Con",font:"50px sans-serif",textColor:"#fff",posX:-200,posY:150}),re.e("text").attr({text:"(Try to cheat them)",font:"15px sans-serif",textColor:"#fff",posX:-200,posY:210}),this},trustButton:function(){return re.e("rect").attr({color:"#0c0",posY:130,posX:30,sizeX:230,sizeY:120}),re.e("text").attr({text:"Trust",font:"50px sans-serif",posX:50,posY:150}),re.e("text").attr({text:"(Take the deal as it is)",font:"15px sans-serif",posX:50,posY:210}),this},restartButton:function(e){return re.e("rect").attr({color:"#a00",posY:130,posX:-220,sizeX:480,sizeY:120}),re.e("text").attr({text:e,font:"50px sans-serif",textColor:"#fff",posX:-200,posY:165}),this},continueButton:function(e){return re.e("rect").attr({color:"#0c0",posY:130,posX:-220,sizeX:480,sizeY:120}),re.e("text").attr({text:e,font:"50px sans-serif",posX:-200,posY:165}),this},setup:function(e){typeof e=="undefined"?e=this.level:this.level=e;var t=this.characters[e];this.title(t.name).description("Honesty: "+t.honesty+"/5, "+"savvy: "+t.savvy+"/5").story(this.chooseStory(t.risk,t.reward)).conButton().trustButton()},action:function(e){var t=this.characters[this.level];re("draw").dispose(),re.faced[re.currentLevel.index]=!0,re.e("conTrust"),this.title(t.name),e==="con"?randBetween(1,6)<=t.savvy?(re.e("score").addMoney(re.score-t.reward),this.description("Never con a conster; you're out €"+t.reward+"!")):(re.e("score").addMoney(re.score+t.risk),this.description("Always looked like an easy mark; €"+t.risk+" for you")):e==="trust"&&(randBetween(1,6)<=t.honesty?(re.e("score").addMoney(re.score+t.reward),this.description("You have the €"+t.reward+", what a swell person")):(re.e("score").addMoney(re.score-t.risk),this.description("The damn swindler! That's €"+t.risk+" down the drain"))),re.score<0?this.story("Looks like you've been cleaned out. Try again?").restartButton("Restart"):re.faced[4]?this.story("You did it! €"+re.score+" is all yours, "+"care to try again?").continueButton("Restart"):this.continueButton("Continue")},tryAction:function(e,t){if(re.score<0||re.faced[4])return re.scene("load").enter();if(re.faced[re.currentLevel.index])return re.scene("home").enter();t>=130&&t<=250&&(e>=-220&&e<=10?this.action("con"):e>=30&&e<=260&&this.action("trust"))}}).init(function(){this.on({click:this.tryAction})}),re.c("level").requires("automap").defines({setup:function(){re.iso.sizeX=30,re.iso.sizeY=30,re.iso.sizeZ=30,re.layer={npc:1,cursor:2,player:3};for(var e=0;e<this.map.length;e++)for(var t=0;t<this.map[0].length;t++){var n=re.e("isoimage"),r=this.map[e][t];n.frame(r),n.iso(t,e),this.automap(t,e,n)}re.faced[this.index]||re.e("npc").addToLevel(this.index),this.cursor=re.e("cursor").attr("layer",re.layer.cursor),this.player=re.e("isoimage").attr({id:"player",frame:99,layer:re.layer.player,place:re.place})},tileHeight:function(e,t){var n=this.automap(e,t);return n?n.isoHeight():-1},canMoveTo:function(e){var t=this.tileHeight(e.isoX,e.isoY);return t>-1&&t<10},action:function(e){var t=this.automap(e.isoX,e.isoY);return t?t.action():-1}}),re.e("level").attr({index:0,map:[[0,5,5,5,5,5,5,5],[0,0,0,0,0,5,5,5],[0,0,0,0,0,0,5,5],[0,0,0,0,0,5,5,5],[0,0,0,0,0,5,0,5],[0,0,5,5,0,5,0,5],[0,0,5,5,5,0,0,5],[10,0,0,0,5,0,0,5]]}),re.e("level").attr({index:1,map:[[21,1,1,1,1,1,1,6],[1,1,1,1,1,1,1,6],[6,1,6,6,6,6,1,6],[6,6,6,6,6,1,1,6],[6,6,1,1,1,1,1,6],[1,1,1,1,1,1,1,6],[1,1,1,1,1,1,1,6],[6,6,6,6,6,1,1,11]]}),re.e("level").attr({index:2,map:[[22,2,2,2,2,7,7,7],[2,2,2,2,7,7,7,7],[7,2,7,7,7,7,7,7],[7,2,7,7,7,7,7,7],[2,7,7,7,7,7,7,7],[7,2,7,7,7,7,7,7],[2,7,7,7,7,7,7,7],[12,7,7,7,7,7,7,7]]}),re.e("level").attr({index:3,map:[[23,3,3,3,3,8,8,8],[3,3,3,3,3,8,8,8],[8,3,8,8,3,3,8,8],[8,3,8,8,3,3,8,8],[8,3,3,3,3,3,3,8],[8,3,3,3,3,3,3,8],[8,8,8,3,3,3,3,8],[8,8,8,3,3,3,3,13]]}),re.e("level").attr({index:4,map:[[24,9,4,9,4,9,4,9],[9,4,9,4,9,4,9,4],[4,9,4,9,4,9,4,9],[9,4,9,4,9,4,9,4],[4,9,4,9,4,9,4,9],[9,4,9,4,9,4,9,4],[4,9,4,9,4,9,4,9],[9,4,9,4,9,4,9,4]]}),re.e("conTrust").attr({index:0,name:"Honest Joe"}),re.scene("faceOff").enter(function(){re("draw").dispose(),re.e("score").addMoney(re.score),re.e("conTrust").setup(re.currentLevel.index),re.screen.pos(-220,0)}),re.scene("home").enter(function(e){e=e||0,re.currentLevel=re("level")[re.currentLevel.index+e],re("draw").dispose(),re.e("score").addMoney(re.score),re.currentLevel.setup(),re.screen.pos(-220,0)}),re.scene("load").enter(function(){re.load(re.assets).complete(function(){re.currentLevel=re("level")[0],re.score=200,re.faced={},re.place=[0,0],re.scene("home").enter()})}),re.load.path="assets/",re.assets={images:["images/sprites.png"],sounds:[]},re.canvas="#game";